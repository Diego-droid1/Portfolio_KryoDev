<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promocionar Sistema – RandomDevs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a23;
      color: #00fff7;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    h1,
    h2,
    h3,
    p {
      margin-bottom: 1rem;
    }

    button,
    .btn {
      padding: .6rem 1.6rem;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00fff7, #22ffea);
      color: #0a0a23;
      box-shadow: 0 0 15px #22ffea, inset 0 0 12px #00fff7;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #ff00f7, #ea22ff);
      color: #0a0a23;
      box-shadow: 0 0 15px #ea22ff, inset 0 0 12px #ff00f7;
    }

    .featured {
      background: rgba(0, 255, 255, 0.07);
      padding: 1rem;
      border-radius: 14px;
      margin-top: 1rem;
    }

    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      background: url('data:image/svg+xml,\
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">\
        <circle cx="10" cy="20" r="2" fill="#22ffea" fill-opacity=".3"/><circle cx="80" cy="70" r="1.5" fill="#00fff7" fill-opacity=".2"/>\
        </svg>') repeat;
    }

    #no-systems {
      margin-top: 2rem;
      background: rgba(255, 0, 128, 0.1);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="particles"></div>

  <div class="container">
    <h1>Promocionar un Sistema</h1>
    <p>DevCoins disponibles: <span id="coins-display">0</span> Ⓡ</p>

    <div id="promotion-form" style="display:none;">
      <label for="system-select">Selecciona un sistema:</label><br>
      <select id="system-select"></select><br><br>

      <label>DevCoins a usar:</label>
      <input type="number" id="coins-input" min="1" placeholder="Ej. 10" /><br><br>

      <button class="btn btn-primary" id="promote-btn">Promocionar</button>

      <section class="featured" id="featured-section">
        <h2>Sistemas Promocionados</h2>
        <div id="promo-info"></div>
      </section>
    </div>

    <div style="margin-top: 2rem;">
      <label for="add-coins-input">Añadir DevCoins:</label>
      <input type="number" id="add-coins-input" min="1" placeholder="Cantidad" />
      <button class="btn btn-primary" id="add-coins-btn">Añadir</button>
    </div>

    <div id="no-systems" style="display:none;">
      <p>❌ No tienes sistemas creados.</p>
      <button class="btn btn-primary" onclick="window.location.href='store.html'">¿No tienes sistemas? ¡Crea
        uno!</button>
    </div>
  </div>

  <!-- Incluir coins.js -->
  <script src="coins.js"></script>
  <script>
const coinsDisplay = document.getElementById('coins-display');
const coinsInput = document.getElementById('coins-input');
const promoteBtn = document.getElementById('promote-btn');
const featuredSection = document.getElementById('featured-section');
const promoInfo = document.getElementById('promo-info');
const systemSelect = document.getElementById('system-select');
const promotionForm = document.getElementById('promotion-form');
const noSystemsDiv = document.getElementById('no-systems');
const addCoinsBtn = document.getElementById('add-coins-btn');
const addCoinsInput = document.getElementById('add-coins-input');

let products = [];
let promotions = [];

// Función para cargar productos y actualizar el select
function loadProductsIntoSelect() {
  products = JSON.parse(localStorage.getItem('products') || '[]');
  systemSelect.innerHTML = ''; // limpiar opciones

  if (!products.length) {
    promotionForm.style.display = 'none';
    noSystemsDiv.style.display = 'block';
    return;
  }
  promotionForm.style.display = 'block';
  noSystemsDiv.style.display = 'none';

  products.forEach((product, index) => {
    const opt = document.createElement('option');
    opt.value = product.id || index.toString();
    opt.textContent = product.name || `Sistema ${index + 1}`;
    systemSelect.appendChild(opt);
  });
}

function updateDisplay() {
  coinsDisplay.textContent = getDevCoins();

  loadProductsIntoSelect(); // recarga productos para actualizar select

  promotions = JSON.parse(localStorage.getItem('promotions') || '[]');
  const now = new Date();

  // Filtrar promociones no expiradas
  promotions = promotions.filter(p => new Date(p.expiresAt) > now);

  // Ordenar promociones de mayor a menor según amount (monedas pagadas)
  promotions.sort((a, b) => b.amount - a.amount);

  localStorage.setItem('promotions', JSON.stringify(promotions));

  promoInfo.innerHTML = '';

  if (promotions.length === 0) {
    featuredSection.style.display = 'none';
    return;
  }

  featuredSection.style.display = 'block';

  // Mostrar todas las promociones activas ordenadas
  promotions.forEach(promo => {
    const div = document.createElement('div');
    div.style = "margin-bottom: 1rem; padding: 0.6rem; background: rgba(0,255,255,0.1); border-radius: 8px;";
    div.innerHTML = `
      <div>
        Sistema: <b>${promo.systemName}</b> | Pagado: ${promo.amount} Ⓡ | Expira: ${new Date(promo.expiresAt).toLocaleString()}
      </div>
      <button class="btn btn-secondary btn-remove" data-systemid="${promo.systemId}">Quitar</button>
    `;
    promoInfo.appendChild(div);

    // Evento para botón "Quitar"
    div.querySelector('.btn-remove').addEventListener('click', () => {
      if (confirm(`¿Quitar la promoción del sistema "${promo.systemName}"?`)) {
        promotions = promotions.filter(p => p.systemId !== promo.systemId);
        localStorage.setItem('promotions', JSON.stringify(promotions));
        updateDisplay();
      }
    });
  });
}

// Evento click para promover producto
promoteBtn.addEventListener('click', () => {
  const amt = parseInt(coinsInput.value, 10);
  const selectedId = systemSelect.value;

  loadProductsIntoSelect(); // Asegura productos actualizados
  promotions = JSON.parse(localStorage.getItem('promotions') || '[]');

  const selectedProduct = products.find(p => (p.id || products.indexOf(p).toString()) === selectedId);

  if (!amt || amt <= 0) return alert("Ingresa una cantidad válida");
  if (amt > getDevCoins()) return alert("No tienes suficientes DevCoins");
  if (!selectedProduct) return alert("Selecciona un sistema válido");

  const now = new Date();

  const existingPromo = promotions.find(p =>
    p.systemId === (selectedProduct.id || selectedId) &&
    new Date(p.expiresAt) > now
  );

  if (existingPromo) {
    alert("Este sistema ya está promocionado y la promoción sigue activa.");
    return;
  }

  const expiresAt = new Date(now.getTime() + amt * 60 * 1000);

  const newPromo = {
    amount: amt,
    systemId: selectedProduct.id || selectedId,
    systemName: selectedProduct.name,
    startAt: now.toISOString(),
    expiresAt: expiresAt.toISOString()
  };

  promotions.push(newPromo);
  localStorage.setItem('promotions', JSON.stringify(promotions));
  subtractDevCoins(amt);
  coinsInput.value = '';
  updateDisplay();
});

// Evento para añadir DevCoins
addCoinsBtn.addEventListener('click', () => {
  const amount = parseInt(addCoinsInput.value, 10);
  if (!amount || amount <= 0) {
    alert("Ingresa una cantidad válida para añadir");
    return;
  }
  addDevCoins(amount);
  addCoinsInput.value = '';
  alert(`${amount} DevCoins añadidos`);
  updateDisplay();
});

// Inicialización
loadProductsIntoSelect();
updateDisplay();
setInterval(updateDisplay, 30000);
  </script>
</body>

</html>